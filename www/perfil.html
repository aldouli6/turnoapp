<!DOCTYPE html>
<html>
	<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width">
    <!-- <script type="text/javascript" src="cordova.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="css/materialize.css"  media="screen,projection"/>
		<link href="css/simplelogin.css" rel="stylesheet" type="text/css" />
    <link href="css/home.css" rel="stylesheet" type="text/css" />
    <link href="css/turno.css" rel="stylesheet" type="text/css" />
    <link href="https://unpkg.com/dropzone/dist/dropzone.css" rel="stylesheet"/>
    <link href="https://unpkg.com/cropperjs/dist/cropper.css" rel="stylesheet"/>
		<script src="js/simplelogin.js"></script>
    <script src="js/md5.js"></script>
    <script src="js/home.js"></script>
      
    <style type="text/css">
     
    .imgProfile{
        background-repeat: no-repeat;
        top: 3vh;
        height: 15vw;
        width: 15vw;
        background: black;
        position: absolute;
        right: 6vw;
    }
    </style>
  </head>
  <body>
    <div id='main' >
        <div role="divigation">
            <div id="menuToggle">
              <input id="togglecheck" type="checkbox" />
              <span></span>
              <span></span>
              <span></span>
              <ul id="menu">
                <a href="home.html"><li>Inicio</li></a>
                <a href="perfil.html"><li>Perfil</li></a>
                <a href="#"><li>Info</li></a>
                <a href="#" onclick="user.signOut()" ><li>Cerrar Sesión</li></a>
              </ul>
            </div>
            <div id="imagen" class="imgProfile">
                
              </div>
            <div class="content" id="contenido">
                <h2 class="titulo">Perfil</h2>
                <div class="row">
                    <div class="col-xs-12">
                        <div class="form-group form-group-default">
                        <label>Username</label>
                        <h4 id='username'></h4>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-10">
                        <div class="form-group form-group-default">
                            <label>Nombre</label>
                            <input type="text" class="form-control" name="nombre" id="nombre" >
                        </div>
                    </div>
                    <div class="col-xs-2" style="padding: 15px;">
                        <button class="btn btn-primary editar" target="nombre">
                                <i class="fa fa-edit" aria-hidden="true"></i> 
                        </button>  
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-10">
                        <div class="form-group form-group-default">
                            <label>Apellido(s)</label>
                            <input type="text" class="form-control" name="apellidos" id="apellidos" >
                        </div>
                    </div>
                    <div class="col-xs-2" style="padding: 15px;">
                        <button class="btn btn-primary editar" target="apellidos">
                                <i class="fa fa-edit" aria-hidden="true"></i> 
                        </button>  
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-10">
                        <div class="form-group form-group-default">
                        <label >E-mail<span id="bdg-email" class="badge badge-success"></span></label>
                        <input type="email" class="form-control" name="email" id="email" >
                        </div>
                    </div>
                    <div class="col-xs-2" style="padding: 15px;">
                        <button class="btn btn-primary editar" target="email">
                                <i class="fa fa-edit" aria-hidden="true"></i> 
                        </button>  
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-10">
                        <div class="form-group form-group-default">
                        <label >Teléfono<span id="bdg-telefono" class="badge badge-success"></span></label>
                        <input type="text" class="form-control" name="telefono" id="telefono" >
                        </div>
                    </div>
                    <div class="col-xs-2" style="padding: 15px;">
                        <button class="btn btn-primary editar" target="telefono">
                                <i class="fa fa-edit" aria-hidden="true"></i> 
                        </button>  
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <button id="cambiaImagen" class="btn btn-primary" style="width: 85vw; ">
                                <i class="fa fa-refresh" aria-hidden="true"></i> Cambiar Imágen
                        </button>
                        <div class="dropzone hide" id="myDropzone" ></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <button class="btn btn-primary" style="width: 85vw; ">
                            <i class="fa fa-key" aria-hidden="true"></i> Cambiar Contraseña
                        </button>
                    </div>
                </div>
            </div>
            
          </div>
          
          
           
        <div id="noconnection">
            <div>No hay conexión de internet</div>
        </div>
    </div>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="js/variables.js"></script>
    <script src="js/device.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>

    <script src="js/dropzone.js"></script>
    <script src="https://unpkg.com/cropperjs"></script>
    <script type="text/javascript">
    document.addEventListener("deviceready",function() {
      
        
      
    }); 
    var elnewbody=document.getElementById('contenido');
    $('#main').click(function (event) {
        var obj = $(event.target);
        if(obj[0].id != "togglecheck" ){
          if ((obj[0].id != "menu")  && $('#togglecheck').prop('checked') == true ){
            $('#togglecheck').trigger('click');
          }
        }
       });
    
    $(document).ready(function(){
        traeDatos();
        console.log('http://'+IP_LOCAL+':8888/turno/assets/img/profiles/usuarios_'+localStorage.uid+'.png');
        $('.imgProfile').css('background-image','url( http://'+IP_LOCAL+':8888/turno/assets/img/profiles/usuarios_'+localStorage.uid+'.png)');
        $('.imgProfile').css('background-size','15vw 15vw');
        $('#upload_image').attr('action','http://'+IP_LOCAL+':8888/turno/ws/upload.php')
        $('#cambiaImagen').click(function() {
            $('#myDropzone').trigger('click');
        });
        var myDropzone2 = new Dropzone("div#myDropzone", 
            { 
            url: 'http://'+IP_LOCAL+':8888/turno/ws/upload.php',
            method:'POST',
            maxFiles: 1, 
            dictDefaultMessage : 'Arrastra una imágen o dá click aquí!',
            acceptedFiles:'image/*',
            renameFile:'file',
            init: function() {
                _this=this;
                _this.on("sending", function(file, xhr, formData) {
                // Will send the filesize along with the file as POST data.
                formData.append("cmd", "subirImagen");
                formData.append("perfil", localStorage.uid);
                formData.append("tipo", 'usuario');
                });
                _this.on("success", function(file,response) { 
                    _this.removeAllFiles(true);
                    
                    if(response!='0'){
                        //$('#myDropzone').hide();
                        d = new Date();
                        response=response+'?'+d.getTime();
                        console.log(response); 
                        Swal.fire({
                        type: 'success',
                        title: 'Se ha cambiado la imagen con exito',
                        timer: 2000,
                    });
                        $('.imgProfile').css("background-image", "url("+response+")"); 
                    }
                
                });
            },
            transformFile: function(file, done) { 
                var myDropZone = this;
                // Create the image editor overlay
                var editor = document.createElement('div');
                editor.style.position = 'absolute';
                editor.style.left = 0;
                editor.style.right = 0;
                editor.style.top = 0;
                editor.style.bottom = 0;
                editor.style.zIndex = 9999;
                editor.style.backgroundColor = '#000';
                
                elnewbody.appendChild(editor);
                // Create confirm button at the top left of the viewport
                var buttonConfirm = document.createElement('button');
                buttonConfirm.className='btn btn-primary';
                buttonConfirm.style.position = 'absolute';
                buttonConfirm.style.right = '135px';
                buttonConfirm.style.top = '10px';
                buttonConfirm.style.zIndex = 9999;
                buttonConfirm.innerHTML  = '<span class="glyphicon glyphicon-open"></span> Subir Imágen';
                var buttonCancel = document.createElement('button');
                buttonCancel.className='btn btn-danger';
                buttonCancel.style.position = 'absolute';
                buttonCancel.style.right = '10px';
                buttonCancel.style.top = '10px';
                buttonCancel.style.zIndex = 9999;
                buttonCancel.innerHTML  = '<span class="glyphicon glyphicon-remove"></span> Cancelar';
                editor.appendChild(buttonConfirm);
                editor.appendChild(buttonCancel);
                // Create an image node for Cropper.js
                var image = new Image();
                image.src = URL.createObjectURL(file);
                editor.appendChild(image);
                
                // Create Cropper.js
                var cropper = new Cropper(image, { 
                    aspectRatio: 1 ,
                }
                );
                buttonCancel.addEventListener('click', function() {
                    _this.removeAllFiles(true);
                    elnewbody.removeChild(editor);
                });
                buttonConfirm.addEventListener('click', function() {
                // Get the canvas with image data from Cropper.js
                var canvas = cropper.getCroppedCanvas({
                    width: 256,
                    height: 256
                });
                // Turn the canvas into a Blob (file object without a name)
                canvas.toBlob(function(blob) {
                    // Create a new Dropzone file thumbnail
                    myDropZone.createThumbnail(
                    blob,
                    myDropZone.options.thumbnailWidth,
                    myDropZone.options.thumbnailHeight,
                    myDropZone.options.thumbnailMethod,
                    false, 
                    function(dataURL) {
                        
                        // Update the Dropzone file thumbnail
                        myDropZone.emit('thumbnail', file, dataURL);
                        // Return the file to Dropzone
                        done(blob);
                    });
                });
                // Remove the editor from the view
                elnewbody.removeChild(editor);
                });
            }
        });
    });
    $('.editar').click(function() {
        var campo=$(this).attr('target');
        var input=$('#'+campo);
        if (campo=='email' || campo=='telefono') {
            Swal.fire({
                title: 'Estás seguro de editar el '+campo+'?',
                text: "Se tendrá que volver a verificar el correo",
                type: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Si, editar.'
                }).
                then((result) => {
                if (result.value) {
                    $.ajax({
                        async: true,
                        url: API_URL,
                        type: 'get',
                        data: { 
                            task: 'updateColumn', 
                            tabla: 'usuarios',
                            column: campo,
                            valor: input.val(),
                            key: 'usuarioId',
                            id: localStorage.uid
                        },
                        success: function (data) {
                            if(data.ws_error=='0'){
                                Swal.fire({
                                    type: 'success',
                                    title: 'Se ha editado el campo con exito',
                                    timer: 1000,
                                });
                            }
                            
                        },
                        error: function (data) {
                                console.error(data);
                        }
                    });
                }
            });
        }else{
            $.ajax({
                async: true,
                url: API_URL,
                type: 'get',
                data: { 
                    task: 'updateColumn', 
                    tabla: 'usuarios',
                    column: campo,
                    valor: input.val(),
                    key: 'usuarioId',
                    id: localStorage.uid
                },
                success: function (data) {
                    if(data.ws_error=='0'){
                        Swal.fire({
                            type: 'success',
                            title: 'Se ha editado el campo con exito',
                            timer: 1000,
                        });
                    }
                    
                },
                error: function (data) {
                        console.error(data);
                }
            });
        }
    }); 
    function traeDatos(params) {
        $.ajax({
            async: true,
            url: API_URL,
            type: 'get',
            data: { 
                task: 'getDatosUsuario', 
                user: localStorage.uid,
                tipo: '4'
            },
            success: function (data) {
                console.log(data);
                if(data.emailVerificado=='1'){
                    
                    $('#bdg-email').text('Verificado');
                }else{
                    $('#bdg-email').text('No Verificado');
                }
                if(data.telefonoVerificado=='1'){
                    $('#bdg-telefono').text('Verificado');
                }else{
                    $('#bdg-telefono').text('No Verificado');
                }
                $('#username').text('@'+data.username);
                $('#nombre').val(data.nombre);
                $('#apellidos').val(data.apellidos);
                $('#email').val(data.email);
                $('#telefono').val(data.telefono);
            },
            error: function (data) {
                    console.error(data);
                    return false;
            }
        });
    }
    </script>
  </body>
</html>
